-- Seeds para Firebird 5.0 usando identity

-- Converte colunas ID para identity quando necessário
EXECUTE BLOCK AS BEGIN IF (NOT EXISTS(SELECT 1 FROM RDB$RELATION_FIELDS WHERE RDB$RELATION_NAME='MENUS' AND RDB$FIELD_NAME='ID' AND RDB$IDENTITY_TYPE IS NOT NULL)) THEN EXECUTE STATEMENT 'ALTER TABLE MENUS ALTER COLUMN ID ADD GENERATED BY DEFAULT AS IDENTITY' END;
EXECUTE BLOCK AS BEGIN IF (NOT EXISTS(SELECT 1 FROM RDB$RELATION_FIELDS WHERE RDB$RELATION_NAME='MENU_OPCOES' AND RDB$FIELD_NAME='ID' AND RDB$IDENTITY_TYPE IS NOT NULL)) THEN EXECUTE STATEMENT 'ALTER TABLE MENU_OPCOES ALTER COLUMN ID ADD GENERATED BY DEFAULT AS IDENTITY' END;
EXECUTE BLOCK AS BEGIN IF (NOT EXISTS(SELECT 1 FROM RDB$RELATION_FIELDS WHERE RDB$RELATION_NAME='CONVERSAS' AND RDB$FIELD_NAME='ID' AND RDB$IDENTITY_TYPE IS NOT NULL)) THEN EXECUTE STATEMENT 'ALTER TABLE CONVERSAS ALTER COLUMN ID ADD GENERATED BY DEFAULT AS IDENTITY' END;

-- Ajusta RESTART WITH
EXECUTE BLOCK AS BEGIN EXECUTE STATEMENT 'ALTER TABLE MENUS ALTER COLUMN ID RESTART WITH ' || (COALESCE((SELECT MAX(ID) FROM MENUS),0) + 1) END;
EXECUTE BLOCK AS BEGIN EXECUTE STATEMENT 'ALTER TABLE MENU_OPCOES ALTER COLUMN ID RESTART WITH ' || (COALESCE((SELECT MAX(ID) FROM MENU_OPCOES),0) + 1) END;
EXECUTE BLOCK AS BEGIN EXECUTE STATEMENT 'ALTER TABLE CONVERSAS ALTER COLUMN ID RESTART WITH ' || (COALESCE((SELECT MAX(ID) FROM CONVERSAS),0) + 1) END;

-- Menu ativo para cliente 1
MERGE INTO MENUS m
USING (SELECT 1 AS CLIENTE_ID FROM RDB$DATABASE) src
ON (m.CLIENTE_ID = src.CLIENTE_ID AND m.ATIVO = 1)
WHEN NOT MATCHED THEN
  INSERT (CLIENTE_ID, TITULO, ATIVO) VALUES (1, 'Menu principal', 1);

-- Opções do menu root
MERGE INTO MENU_OPCOES mo
USING (SELECT (SELECT ID FROM MENUS WHERE CLIENTE_ID=1 AND ATIVO=1) AS MENU_ID FROM RDB$DATABASE) src
ON (mo.MENU_ID = src.MENU_ID AND mo.CHAVE_PAI='root' AND mo.OPCAO='1')
WHEN NOT MATCHED THEN
  INSERT (MENU_ID, CHAVE_PAI, OPCAO, TEXTO, PROXIMA_CHAVE, ORDEM)
  VALUES (src.MENU_ID, 'root', '1', 'Detalhes da entrega', 'ASK_NOMOVTRA', 1);

MERGE INTO MENU_OPCOES mo
USING (SELECT (SELECT ID FROM MENUS WHERE CLIENTE_ID=1 AND ATIVO=1) AS MENU_ID FROM RDB$DATABASE) src
ON (mo.MENU_ID = src.MENU_ID AND mo.CHAVE_PAI='root' AND mo.OPCAO='2')
WHEN NOT MATCHED THEN
  INSERT (MENU_ID, CHAVE_PAI, OPCAO, TEXTO, PROXIMA_CHAVE, ORDEM)
  VALUES (src.MENU_ID, 'root', '2', 'Registrar ocorrência', 'ASK_OCORRENCIA_TEXTO', 2);

MERGE INTO MENU_OPCOES mo
USING (SELECT (SELECT ID FROM MENUS WHERE CLIENTE_ID=1 AND ATIVO=1) AS MENU_ID FROM RDB$DATABASE) src
ON (mo.MENU_ID = src.MENU_ID AND mo.CHAVE_PAI='root' AND mo.OPCAO='3')
WHEN NOT MATCHED THEN
  INSERT (MENU_ID, CHAVE_PAI, OPCAO, TEXTO, PROXIMA_CHAVE, ORDEM)
  VALUES (src.MENU_ID, 'root', '3', 'Enviar CT-e', 'ASK_CTE_ARQUIVO_OU_CHAVE', 3);

MERGE INTO MENU_OPCOES mo
USING (SELECT (SELECT ID FROM MENUS WHERE CLIENTE_ID=1 AND ATIVO=1) AS MENU_ID FROM RDB$DATABASE) src
ON (mo.MENU_ID = src.MENU_ID AND mo.CHAVE_PAI='root' AND mo.OPCAO='4')
WHEN NOT MATCHED THEN
  INSERT (MENU_ID, CHAVE_PAI, OPCAO, TEXTO, PROXIMA_CHAVE, ORDEM)
  VALUES (src.MENU_ID, 'root', '4', 'Enviar doc. motorista', 'ASK_DOC_MOTORISTA', 4);

MERGE INTO MENU_OPCOES mo
USING (SELECT (SELECT ID FROM MENUS WHERE CLIENTE_ID=1 AND ATIVO=1) AS MENU_ID FROM RDB$DATABASE) src
ON (mo.MENU_ID = src.MENU_ID AND mo.CHAVE_PAI='root' AND mo.OPCAO='5')
WHEN NOT MATCHED THEN
  INSERT (MENU_ID, CHAVE_PAI, OPCAO, TEXTO, PROXIMA_CHAVE, ORDEM)
  VALUES (src.MENU_ID, 'root', '5', 'Enviar doc. veículo', 'ASK_DOC_VEICULO', 5);
